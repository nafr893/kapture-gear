{%- comment -%}
  System Builder Section
  A multi-step product configurator for optic adapters and phone cases.

  - optic_brand: Optic manufacturers
  - optic_model: Specific optic models with product references
  - phone_brand: Phone manufacturers
  - phone_model: Phone models with case product references
{%- endcomment -%}

{{ 'system-builder.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign optic_brands = shop.metaobjects.optic_brand.values
  assign optic_models = shop.metaobjects.optic_model.values
  assign phone_brands = shop.metaobjects.phone_brand.values
  assign phone_models = shop.metaobjects.phone_model.values
-%}

<system-builder class="system-builder section-{{ section.id }}" id="system-builder-{{ section.id }}">
  {%- comment -%} Data payloads for JavaScript {%- endcomment -%}
  <script type="application/json" data-optic-brands>
    [
      {%- for brand in optic_brands -%}
        {
          "id": {{ brand.id | json }},
          "handle": {{ brand.system.handle | json }},
          "name": {{ brand.optic_brand | json }},
          "logo": {{ brand.logo | json }}
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  </script>

  <script type="application/json" data-optic-models>
    [
      {%- for model in optic_models -%}
        {%- comment -%} For list-type variant references, get the first item {%- endcomment -%}
        {%- assign ring_mount_variant = model.ring_mount.value | first -%}
        {%- assign mag_ring_variant = model.mag_ring.value | first -%}
        {
          "id": {{ model.id | json }},
          "handle": {{ model.system.handle | json }},
          "name": {{ model.optic_model | json }},
          "brandHandle": {{ model.brand.value.system.handle | default: '' | json }},
          "image": {{ model.image | json }},
          "modelImage": {% if model.model_image %}{{ model.model_image | image_url: width: 400 | json }}{% else %}null{% endif %},
          "productNotice": {{ model.product_notice | json }},
          "ringMount": {%- if ring_mount_variant -%}{
            "id": {{ ring_mount_variant.id | json }},
            "title": {{ ring_mount_variant.title | json }},
            "price": {{ ring_mount_variant.price | json }},
            "productTitle": {{ ring_mount_variant.product.title | json }},
            "image": {{ ring_mount_variant.image.src | default: ring_mount_variant.product.featured_image | json }},
            "available": {{ ring_mount_variant.available | json }}
          }{%- else -%}null{%- endif -%},
          "magRing": {%- if mag_ring_variant -%}{
            "id": {{ mag_ring_variant.id | json }},
            "title": {{ mag_ring_variant.title | json }},
            "price": {{ mag_ring_variant.price | json }},
            "productTitle": {{ mag_ring_variant.product.title | json }},
            "image": {{ mag_ring_variant.image.src | default: mag_ring_variant.product.featured_image | json }},
            "available": {{ mag_ring_variant.available | json }}
          }{%- else -%}null{%- endif -%}
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  </script>

  {%- comment -%} Adapter product data (universal) - formatted like variant data for consistency {%- endcomment -%}
  <script type="application/json" data-adapter-product>
    {%- if section.settings.adapter_product -%}
      {%- assign adapter = section.settings.adapter_product -%}
      {%- assign adapter_variant = adapter.selected_or_first_available_variant -%}
      {
        "id": {{ adapter_variant.id | json }},
        "title": {{ adapter_variant.title | json }},
        "price": {{ adapter_variant.price | json }},
        "productTitle": {{ adapter.title | json }},
        "image": {{ adapter_variant.image.src | default: adapter.featured_image | json }},
        "available": {{ adapter_variant.available | json }}
      }
    {%- else -%}
      null
    {%- endif -%}
  </script>

  <script type="application/json" data-phone-brands>
    [
      {%- for brand in phone_brands -%}
        {
          "id": {{ brand.id | json }},
          "handle": {{ brand.system.handle | json }},
          "name": {{ brand.phone_brand | json }},
          "logo": {{ brand.logo | json }}
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  </script>

  <script type="application/json" data-phone-models>
    [
      {%- for model in phone_models -%}
        {%- comment -%} For list-type variant references, get the first item {%- endcomment -%}
        {%- assign phone_case_variant = model.phone_case.value | first -%}
        {
          "id": {{ model.id | json }},
          "handle": {{ model.system.handle | json }},
          "name": {{ model.phone_model | json }},
          "brandHandle": {{ model.brand.value.system.handle | default: '' | json }},
          "phoneCase": {%- if phone_case_variant -%}{
            "id": {{ phone_case_variant.id | json }},
            "title": {{ phone_case_variant.title | json }},
            "price": {{ phone_case_variant.price | json }},
            "productTitle": {{ phone_case_variant.product.title | json }},
            "image": {{ phone_case_variant.image.src | default: phone_case_variant.product.featured_image | json }},
            "available": {{ phone_case_variant.available | json }}
          }{%- else -%}null{%- endif -%}
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  </script>

  {%- comment -%} Accessories products data (from blocks) {%- endcomment -%}
  <script type="application/json" data-accessories>
    [
      {%- for block in section.blocks -%}
        {%- if block.type == 'accessory' and block.settings.product -%}
          {%- assign accessory = block.settings.product -%}
          {%- assign accessory_variant = accessory.selected_or_first_available_variant -%}
          {
            "id": {{ accessory_variant.id | json }},
            "blockId": {{ block.id | json }},
            "title": {{ accessory_variant.title | json }},
            "price": {{ accessory_variant.price | json }},
            "productTitle": {{ accessory.title | json }},
            "image": {{ accessory_variant.image.src | default: accessory.featured_image | json }},
            "available": {{ accessory_variant.available | json }}
          }{%- unless forloop.last -%},{%- endunless -%}
        {%- endif -%}
      {%- endfor -%}
    ]
  </script>

  <div class="system-builder__container container">
    {%- if section.settings.heading != blank -%}
      <h2 class="system-builder__heading h2">{{ section.settings.heading }}</h2>
    {%- endif -%}

    {%- if section.settings.subheading != blank -%}
      <div class="system-builder__subheading rte">{{ section.settings.subheading }}</div>
    {%- endif -%}

    <div class="system-builder__layout">
      {%- comment -%} Left Column: Steps {%- endcomment -%}
      <div class="system-builder__steps">
        {%- comment -%} Step 1: Optic Selection {%- endcomment -%}
        <div class="system-builder__step" data-step="optic">
      <div class="system-builder__step-header">
        {%- if section.settings.optic_image != blank -%}
          <div class="system-builder__step-image">
            {{ section.settings.optic_image | image_url: width: 200 | image_tag: loading: 'lazy' }}
          </div>
        {%- endif -%}
        <div class="system-builder__step-content">
          <h3 class="system-builder__step-title h4">{{ section.settings.optic_step_title }}</h3>

          {%- comment -%} Manufacturer Selection {%- endcomment -%}
          <div class="system-builder__field" data-field="optic-brand">
            <label class="system-builder__label">{{ section.settings.manufacturer_label | default: 'Manufacturer' }}</label>
            <div class="system-builder__chips" data-chips="optic-brand">
              {%- for brand in optic_brands -%}
                {%- render 'system-builder-option-chip',
                  value: brand.system.handle,
                  label: brand.optic_brand,
                  field: 'optic-brand'
                -%}
              {%- else -%}
                <p class="system-builder__empty-message">No optic brands configured. Add entries to the "optic_brand" metaobject.</p>
              {%- endfor -%}
            </div>
          </div>

          {%- comment -%} Model Selection {%- endcomment -%}
          <div class="system-builder__field" data-field="optic-model" hidden>
            <div class="system-builder__label-row">
              <label class="system-builder__label">{{ section.settings.model_label | default: 'Model' }}</label>
              <span class="system-builder__notice-link" data-model-notice-link hidden role="button" tabindex="0" aria-label="View product notice">Notice</span>
            </div>
            <div class="system-builder__chips" data-chips="optic-model">
              {%- comment -%} Populated by JavaScript based on brand selection {%- endcomment -%}
            </div>
          </div>

          {%- comment -%} Selected Model Image Preview {%- endcomment -%}
          <div class="system-builder__model-preview" data-model-preview hidden>
            <div class="system-builder__model-preview-image" data-model-preview-image></div>
          </div>
        </div>
      </div>
    </div>

    {%- comment -%} Step 2: Ring Mount (User selectable based on optic model) {%- endcomment -%}
    <div class="system-builder__step system-builder__step--product" data-step="ring-mount" hidden>
      <h3 class="system-builder__step-title h4">{{ section.settings.ring_mount_step_title }}</h3>
      <div class="system-builder__product-display" data-product="ring-mount">
        {%- comment -%} Product card populated by JavaScript {%- endcomment -%}
        <p class="system-builder__placeholder">Select your optic to see the compatible ring mount.</p>
      </div>
    </div>

    {%- comment -%} Step 3: Mag Ring (Auto-selected based on optic model) {%- endcomment -%}
    <div class="system-builder__step system-builder__step--product" data-step="mag-ring" hidden>
      <h3 class="system-builder__step-title h4">{{ section.settings.mag_ring_step_title }}</h3>
      <div class="system-builder__product-display" data-product="mag-ring">
        {%- comment -%} Product card populated by JavaScript {%- endcomment -%}
        <p class="system-builder__placeholder">Select your optic to see the compatible mag ring.</p>
      </div>
    </div>

    {%- comment -%} Step 4: Adapter (Universal product) {%- endcomment -%}
    <div class="system-builder__step system-builder__step--product" data-step="adapter">
      <h3 class="system-builder__step-title h4">{{ section.settings.adapter_step_title }}</h3>
      <div class="system-builder__product-display" data-product="adapter">
        {%- comment -%} Product card populated by JavaScript from section settings {%- endcomment -%}
        <p class="system-builder__placeholder">Adapter will be shown here.</p>
      </div>
    </div>

    {%- comment -%} Step 4: Phone Case Selection {%- endcomment -%}
    <div class="system-builder__step" data-step="phone">
      <h3 class="system-builder__step-title h4">{{ section.settings.phone_step_title }}</h3>

      {%- comment -%} Phone Brand Selection {%- endcomment -%}
      <div class="system-builder__field" data-field="phone-brand">
        <label class="system-builder__label">{{ section.settings.phone_brand_label | default: 'Phone Brand' }}</label>
        <div class="system-builder__chips" data-chips="phone-brand">
          {%- for brand in phone_brands -%}
            {%- render 'system-builder-option-chip',
              value: brand.system.handle,
              label: brand.phone_brand,
              field: 'phone-brand'
            -%}
          {%- else -%}
            <p class="system-builder__empty-message">No phone brands configured. Add entries to the "phone_brand" metaobject.</p>
          {%- endfor -%}
        </div>
      </div>

      {%- comment -%} Phone Model Selection {%- endcomment -%}
      <div class="system-builder__field" data-field="phone-model" hidden>
        <label class="system-builder__label">{{ section.settings.phone_model_label | default: 'Phone Model' }}</label>
        <div class="system-builder__chips" data-chips="phone-model">
          {%- comment -%} Populated by JavaScript based on brand selection {%- endcomment -%}
        </div>
      </div>

        {%- comment -%} Phone Case (Auto-selected) {%- endcomment -%}
        <div class="system-builder__product-display" data-product="phone-case" hidden>
          {%- comment -%} Product card populated by JavaScript {%- endcomment -%}
        </div>
      </div>

    {%- comment -%} Step 6: Accessories (from blocks) {%- endcomment -%}
    {%- if section.blocks.size > 0 -%}
      <div class="system-builder__step system-builder__step--accessories" data-step="accessories">
        <h3 class="system-builder__step-title h4">{{ section.settings.accessories_step_title }}</h3>
        <div class="system-builder__accessories-grid" data-accessories-grid>
          {%- comment -%} Product cards populated by JavaScript {%- endcomment -%}
        </div>
      </div>
    {%- endif -%}
    </div>{%- comment -%} End .system-builder__steps {%- endcomment -%}

    {%- comment -%} Right Column: Summary Sidebar {%- endcomment -%}
    <div class="system-builder__sidebar">
      <div class="system-builder__summary" data-summary>
        <h3 class="system-builder__summary-title h4">{{ section.settings.summary_title | default: 'Your Selection' }}</h3>

        {%- comment -%} All summary items dynamically populated by JavaScript {%- endcomment -%}
        <div class="system-builder__summary-items" data-summary-items>
        </div>

        <div class="system-builder__summary-empty" data-summary-empty>
          <p>Select products to add to your system.</p>
        </div>

        <div class="system-builder__summary-footer" data-summary-footer hidden>
          <div class="system-builder__summary-total">
            <span class="system-builder__summary-total-label">{{ section.settings.total_label | default: 'Total' }}</span>
            <span class="system-builder__summary-total-price" data-total-price></span>
          </div>

          <button type="button" class="system-builder__add-to-cart button button--primary" data-add-to-cart>
            {{ section.settings.add_to_cart_text | default: 'Add All to Cart' }}
          </button>
        </div>
      </div>
    </div>{%- comment -%} End .system-builder__sidebar {%- endcomment -%}
  </div>{%- comment -%} End .system-builder__layout {%- endcomment -%}
</div>

{%- comment -%} Product Notice Overlay {%- endcomment -%}
<div class="system-builder__notice-overlay" data-notice-overlay hidden>
  <div class="system-builder__notice-modal">
    <button type="button" class="system-builder__notice-close" data-notice-close aria-label="Close">&times;</button>
    <p class="system-builder__notice-text" data-notice-text></p>
  </div>
</div>
</system-builder>

<script src="{{ 'system-builder.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "System Builder",
  "tag": "section",
  "class": "shopify-section--system-builder",
  "settings": [
    {
      "type": "header",
      "content": "General"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Build Your System"
    },
    {
      "type": "richtext",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "header",
      "content": "Optic Selection"
    },
    {
      "type": "text",
      "id": "optic_step_title",
      "label": "Step Title",
      "default": "1. Select Your Optic"
    },
    {
      "type": "image_picker",
      "id": "optic_image",
      "label": "Optic Image"
    },
    {
      "type": "text",
      "id": "manufacturer_label",
      "label": "Manufacturer Label",
      "default": "Manufacturer"
    },
    {
      "type": "text",
      "id": "model_label",
      "label": "Model Label",
      "default": "Model"
    },
    {
      "type": "header",
      "content": "Ring Mount"
    },
    {
      "type": "text",
      "id": "ring_mount_step_title",
      "label": "Step Title",
      "default": "2. Your Ring Mount"
    },
    {
      "type": "header",
      "content": "Mag Ring"
    },
    {
      "type": "text",
      "id": "mag_ring_step_title",
      "label": "Step Title",
      "default": "3. Your Mag Ring"
    },
    {
      "type": "header",
      "content": "Adapter"
    },
    {
      "type": "text",
      "id": "adapter_step_title",
      "label": "Step Title",
      "default": "4. Adapter"
    },
    {
      "type": "product",
      "id": "adapter_product",
      "label": "Adapter Product",
      "info": "Select the universal adapter product"
    },
    {
      "type": "header",
      "content": "Phone Case"
    },
    {
      "type": "text",
      "id": "phone_step_title",
      "label": "Step Title",
      "default": "5. Select Your Phone Case"
    },
    {
      "type": "text",
      "id": "phone_brand_label",
      "label": "Phone Brand Label",
      "default": "Phone Brand"
    },
    {
      "type": "text",
      "id": "phone_model_label",
      "label": "Phone Model Label",
      "default": "Phone Model"
    },
    {
      "type": "header",
      "content": "Accessories"
    },
    {
      "type": "text",
      "id": "accessories_step_title",
      "label": "Step Title",
      "default": "6. Accessories"
    },
    {
      "type": "header",
      "content": "Summary"
    },
    {
      "type": "text",
      "id": "summary_title",
      "label": "Summary Title",
      "default": "Your Selection"
    },
    {
      "type": "text",
      "id": "total_label",
      "label": "Total Label",
      "default": "Total"
    },
    {
      "type": "text",
      "id": "add_to_cart_text",
      "label": "Add to Cart Button Text",
      "default": "Add All to Cart"
    }
  ],
  "blocks": [
    {
      "type": "accessory",
      "name": "Accessory",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Accessory Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "System Builder"
    }
  ]
}
{% endschema %}