{%- comment -%}
  System Builder Section
  A multi-step product configurator for optic adapters and phone cases.

  Data is loaded from metaobjects:
  - optic_brand: Optic manufacturers
  - optic_model: Specific optic models with product references
  - phone_brand: Phone manufacturers
  - phone_model: Phone models with case product references
{%- endcomment -%}

{{ 'system-builder.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign optic_brands = shop.metaobjects.optic_brand.values
  assign optic_models = shop.metaobjects.optic_model.values
  assign phone_brands = shop.metaobjects.phone_brand.values
  assign phone_models = shop.metaobjects.phone_model.values
-%}

<system-builder class="system-builder section-{{ section.id }}" id="system-builder-{{ section.id }}">
  {%- comment -%} Data payloads for JavaScript {%- endcomment -%}
  <script type="application/json" data-optic-brands>
    [
      {%- for brand in optic_brands -%}
        {
          "id": {{ brand.id | json }},
          "handle": {{ brand.system.handle | json }},
          "name": {{ brand.name | json }},
          "logo": {{ brand.logo | json }}
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  </script>

  <script type="application/json" data-optic-models>
    [
      {%- for model in optic_models -%}
        {
          "id": {{ model.id | json }},
          "handle": {{ model.system.handle | json }},
          "name": {{ model.name | json }},
          "brandHandle": {{ model.brand.value.system.handle | default: '' | json }},
          "image": {{ model.image | json }},
          "magRingIntegrated": {%- if model.mag_ring_integrated.value -%}{{ model.mag_ring_integrated.value | json }}{%- else -%}null{%- endif -%},
          "magRingEyecup": {%- if model.mag_ring_eyecup.value -%}{{ model.mag_ring_eyecup.value | json }}{%- else -%}null{%- endif -%},
          "adapterIntegrated": {%- if model.adapter_integrated.value -%}{{ model.adapter_integrated.value | json }}{%- else -%}null{%- endif -%},
          "adapterEyecup": {%- if model.adapter_eyecup.value -%}{{ model.adapter_eyecup.value | json }}{%- else -%}null{%- endif -%}
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  </script>

  <script type="application/json" data-phone-brands>
    [
      {%- for brand in phone_brands -%}
        {
          "id": {{ brand.id | json }},
          "handle": {{ brand.system.handle | json }},
          "name": {{ brand.name | json }},
          "logo": {{ brand.logo | json }}
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  </script>

  <script type="application/json" data-phone-models>
    [
      {%- for model in phone_models -%}
        {
          "id": {{ model.id | json }},
          "handle": {{ model.system.handle | json }},
          "name": {{ model.name | json }},
          "brandHandle": {{ model.brand.value.system.handle | default: '' | json }},
          "phoneCase": {%- if model.phone_case.value -%}{{ model.phone_case.value | json }}{%- else -%}null{%- endif -%}
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  </script>

  <div class="system-builder__container container">
    {%- if section.settings.heading != blank -%}
      <h2 class="system-builder__heading h2">{{ section.settings.heading }}</h2>
    {%- endif -%}

    {%- if section.settings.subheading != blank -%}
      <div class="system-builder__subheading rte">{{ section.settings.subheading }}</div>
    {%- endif -%}

    {%- comment -%} Step 1: Optic Selection {%- endcomment -%}
    <div class="system-builder__step" data-step="optic">
      <div class="system-builder__step-header">
        {%- if section.settings.optic_image != blank -%}
          <div class="system-builder__step-image">
            {{ section.settings.optic_image | image_url: width: 200 | image_tag: loading: 'lazy' }}
          </div>
        {%- endif -%}
        <div class="system-builder__step-content">
          <h3 class="system-builder__step-title h4">{{ section.settings.optic_step_title }}</h3>

          {%- comment -%} Manufacturer Selection {%- endcomment -%}
          <div class="system-builder__field" data-field="optic-brand">
            <label class="system-builder__label">{{ section.settings.manufacturer_label | default: 'Manufacturer' }}</label>
            <div class="system-builder__chips" data-chips="optic-brand">
              {%- for brand in optic_brands -%}
                {%- render 'system-builder-option-chip',
                  value: brand.system.handle,
                  label: brand.name,
                  field: 'optic-brand'
                -%}
              {%- else -%}
                <p class="system-builder__empty-message">No optic brands configured. Add entries to the "optic_brand" metaobject.</p>
              {%- endfor -%}
            </div>
          </div>

          {%- comment -%} Model Selection {%- endcomment -%}
          <div class="system-builder__field" data-field="optic-model" hidden>
            <label class="system-builder__label">{{ section.settings.model_label | default: 'Model' }}</label>
            <div class="system-builder__chips" data-chips="optic-model">
              {%- comment -%} Populated by JavaScript based on brand selection {%- endcomment -%}
            </div>
          </div>

          {%- comment -%} Mount Type Selection {%- endcomment -%}
          <div class="system-builder__field" data-field="mount-type" hidden>
            <label class="system-builder__label">{{ section.settings.mount_type_label | default: 'Mount Type' }}</label>
            <div class="system-builder__chips" data-chips="mount-type">
              {%- render 'system-builder-option-chip',
                value: 'integrated',
                label: 'Integrated Ring Mount',
                field: 'mount-type'
              -%}
              {%- render 'system-builder-option-chip',
                value: 'eyecup',
                label: 'Eyecup',
                field: 'mount-type'
              -%}
            </div>
          </div>
        </div>
      </div>
    </div>

    {%- comment -%} Step 2: Mag Ring (Auto-selected) {%- endcomment -%}
    <div class="system-builder__step system-builder__step--product" data-step="mag-ring" hidden>
      <h3 class="system-builder__step-title h4">{{ section.settings.mag_ring_step_title }}</h3>
      <div class="system-builder__product-display" data-product="mag-ring">
        {%- comment -%} Product card populated by JavaScript {%- endcomment -%}
        <p class="system-builder__placeholder">Select your optic to see the compatible mag ring.</p>
      </div>
    </div>

    {%- comment -%} Step 3: Adapter (Auto-selected) {%- endcomment -%}
    <div class="system-builder__step system-builder__step--product" data-step="adapter" hidden>
      <h3 class="system-builder__step-title h4">{{ section.settings.adapter_step_title }}</h3>
      <div class="system-builder__product-display" data-product="adapter">
        {%- comment -%} Product card populated by JavaScript {%- endcomment -%}
        <p class="system-builder__placeholder">Select your optic to see the compatible adapter.</p>
      </div>
    </div>

    {%- comment -%} Step 4: Phone Case Selection {%- endcomment -%}
    <div class="system-builder__step" data-step="phone">
      <h3 class="system-builder__step-title h4">{{ section.settings.phone_step_title }}</h3>

      {%- comment -%} Phone Brand Selection {%- endcomment -%}
      <div class="system-builder__field" data-field="phone-brand">
        <label class="system-builder__label">{{ section.settings.phone_brand_label | default: 'Phone Brand' }}</label>
        <div class="system-builder__chips" data-chips="phone-brand">
          {%- for brand in phone_brands -%}
            {%- render 'system-builder-option-chip',
              value: brand.system.handle,
              label: brand.name,
              field: 'phone-brand'
            -%}
          {%- else -%}
            <p class="system-builder__empty-message">No phone brands configured. Add entries to the "phone_brand" metaobject.</p>
          {%- endfor -%}
        </div>
      </div>

      {%- comment -%} Phone Model Selection {%- endcomment -%}
      <div class="system-builder__field" data-field="phone-model" hidden>
        <label class="system-builder__label">{{ section.settings.phone_model_label | default: 'Phone Model' }}</label>
        <div class="system-builder__chips" data-chips="phone-model">
          {%- comment -%} Populated by JavaScript based on brand selection {%- endcomment -%}
        </div>
      </div>

      {%- comment -%} Phone Case (Auto-selected) {%- endcomment -%}
      <div class="system-builder__product-display" data-product="phone-case" hidden>
        {%- comment -%} Product card populated by JavaScript {%- endcomment -%}
      </div>
    </div>

    {%- comment -%} Summary & Add to Cart {%- endcomment -%}
    <div class="system-builder__summary" data-summary hidden>
      <h3 class="system-builder__summary-title h4">{{ section.settings.summary_title | default: 'Your Selection' }}</h3>

      <div class="system-builder__summary-items">
        <div class="system-builder__summary-item" data-summary-item="mag-ring">
          <span class="system-builder__summary-name" data-summary-name></span>
          <span class="system-builder__summary-price" data-summary-price></span>
        </div>
        <div class="system-builder__summary-item" data-summary-item="adapter">
          <span class="system-builder__summary-name" data-summary-name></span>
          <span class="system-builder__summary-price" data-summary-price></span>
        </div>
        <div class="system-builder__summary-item" data-summary-item="phone-case">
          <span class="system-builder__summary-name" data-summary-name></span>
          <span class="system-builder__summary-price" data-summary-price></span>
        </div>
      </div>

      <div class="system-builder__summary-total">
        <span class="system-builder__summary-total-label">{{ section.settings.total_label | default: 'Total' }}</span>
        <span class="system-builder__summary-total-price" data-total-price></span>
      </div>

      <button type="button" class="system-builder__add-to-cart button button--primary" data-add-to-cart>
        {{ section.settings.add_to_cart_text | default: 'Add All to Cart' }}
      </button>
    </div>
  </div>
</system-builder>

<script src="{{ 'system-builder.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "System Builder",
  "tag": "section",
  "class": "shopify-section--system-builder",
  "settings": [
    {
      "type": "header",
      "content": "General"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Build Your System"
    },
    {
      "type": "richtext",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "header",
      "content": "Optic Selection"
    },
    {
      "type": "text",
      "id": "optic_step_title",
      "label": "Step Title",
      "default": "1. Select Your Optic"
    },
    {
      "type": "image_picker",
      "id": "optic_image",
      "label": "Optic Image"
    },
    {
      "type": "text",
      "id": "manufacturer_label",
      "label": "Manufacturer Label",
      "default": "Manufacturer"
    },
    {
      "type": "text",
      "id": "model_label",
      "label": "Model Label",
      "default": "Model"
    },
    {
      "type": "text",
      "id": "mount_type_label",
      "label": "Mount Type Label",
      "default": "Mount Type"
    },
    {
      "type": "header",
      "content": "Mag Ring"
    },
    {
      "type": "text",
      "id": "mag_ring_step_title",
      "label": "Step Title",
      "default": "2. Your Mag Ring"
    },
    {
      "type": "header",
      "content": "Adapter"
    },
    {
      "type": "text",
      "id": "adapter_step_title",
      "label": "Step Title",
      "default": "3. Your Adapter"
    },
    {
      "type": "header",
      "content": "Phone Case"
    },
    {
      "type": "text",
      "id": "phone_step_title",
      "label": "Step Title",
      "default": "4. Select Your Phone Case"
    },
    {
      "type": "text",
      "id": "phone_brand_label",
      "label": "Phone Brand Label",
      "default": "Phone Brand"
    },
    {
      "type": "text",
      "id": "phone_model_label",
      "label": "Phone Model Label",
      "default": "Phone Model"
    },
    {
      "type": "header",
      "content": "Summary"
    },
    {
      "type": "text",
      "id": "summary_title",
      "label": "Summary Title",
      "default": "Your Selection"
    },
    {
      "type": "text",
      "id": "total_label",
      "label": "Total Label",
      "default": "Total"
    },
    {
      "type": "text",
      "id": "add_to_cart_text",
      "label": "Add to Cart Button Text",
      "default": "Add All to Cart"
    }
  ],
  "presets": [
    {
      "name": "System Builder"
    }
  ]
}
{% endschema %}
